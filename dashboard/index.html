<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>Swarm 监控页</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 20px; color:#222; }
    h1 { margin-bottom: 6px; }
    .meta { color:#666; margin-bottom: 12px; }
    table { width:100%; border-collapse: collapse; }
    th, td { border: 1px solid #e5e5e5; padding: 8px; text-align: left; }
    th { background:#f6f6f6; }
    .tag { display:inline-block; padding:2px 6px; border-radius:6px; font-size:12px; }
    .running { background:#e8f5e9; color:#2e7d32; }
    .ready { background:#e3f2fd; color:#1565c0; }
    .blocked { background:#fff3e0; color:#ef6c00; }
    .stopped { background:#ffebee; color:#c62828; }
    .muted { color:#888; font-size:12px; }
  </style>
</head>
<body>
  <h1>Swarm 实时看板</h1>
  <div class="meta">数据来源：.clawdbot/active-tasks.json</div>
  <div class="meta">更新时间：<span id="ts">-</span></div>

  <table>
    <thead>
      <tr>
        <th>任务ID</th>
        <th>Agent</th>
        <th>状态</th>
        <th>分支</th>
        <th>工作区</th>
        <th>tmux</th>
        <th>PR</th>
        <th>CI</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>

<script>
const tbody = document.getElementById('rows');
const ts = document.getElementById('ts');

const statusClass = (s) => (s||'').toLowerCase();

function render(data) {
  const tasks = data.tasks || [];
  ts.textContent = new Date(data.updatedAt).toLocaleString();
  tbody.innerHTML = '';
  tasks.forEach(t => {
    const tr = document.createElement('tr');
    const status = t.status || '-';
    const statusTag = `<span class="tag ${statusClass(status)}">${status}</span>`;
    const pr = t.prUrl ? `<a href="${t.prUrl}" target="_blank">#${t.prNumber || ''}</a>` : '-';
    const ci = t.checksState || '-';

    tr.innerHTML = `
      <td>${t.id || '-'}</td>
      <td>${t.agent || '-'}</td>
      <td>${statusTag}</td>
      <td>${t.branch || '-'}</td>
      <td class="muted">${t.worktree || '-'}</td>
      <td>${t.tmuxSession || '-'}</td>
      <td>${pr}</td>
      <td>${ci}</td>
    `;
    tbody.appendChild(tr);
  });
}

// SSE realtime
const evt = new EventSource('/events');
evt.onmessage = (e) => {
  try { render(JSON.parse(e.data)); } catch {}
};

// fallback polling if SSE fails
setInterval(async () => {
  try {
    const res = await fetch('/api/tasks');
    const data = await res.json();
    render(data);
  } catch {}
}, 10000);
</script>
</body>
</html>
